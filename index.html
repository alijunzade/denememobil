<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Boyama Sava≈ülarƒ±: Mobil</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        :root {
            --bg-ocean: #2c3e50;
            --p1-color: #ff7675;
            --p2-color: #74b9ff;
            --panel-bg: rgba(255, 255, 255, 0.95);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            overflow: hidden;
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #1e272e 0%, #485460 100%);
            /* MOBƒ∞L ƒ∞√áƒ∞N KRƒ∞Tƒ∞K AYAR: Dinamik Y√ºkseklik */
            height: 100vh; 
            height: 100dvh; 
            display: flex; flex-direction: column;
            user-select: none; touch-action: none;
        }

        /* --- √úST G√ú√á BARI (Sabit) --- */
        #tugOfWarBar {
            height: 24px; min-height: 24px; width: 100%; display: flex;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 50; background: #333;
            overflow: hidden; /* Ta≈üan √ßizgiyi gizle */
            flex-shrink: 0; /* Asla b√ºz√º≈üme */
        }
        #barP1 { height: 100%; background: var(--p1-color); width: 50%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: flex-start; padding-left: 10px; color: white; font-size: 11px; white-space: nowrap; font-weight:bold;}
        #barP2 { height: 100%; background: var(--p2-color); width: 50%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: #333; font-size: 11px; white-space: nowrap; font-weight:bold;}
        #barCenter { width: 4px; background: #fff; height: 100%; position: relative; z-index: 51; box-shadow: 0 0 10px white; }

        /* --- ANA D√úZEN --- */
        #gameLayout {
            display: flex; flex-direction: column;
            width: 100%; 
            flex: 1; /* Kalan t√ºm y√ºksekliƒüi al */
            padding: 10px; gap: 10px;
            overflow: hidden;
        }

        /* --- HARƒ∞TA (Esnek - K√º√ß√ºlebilir) --- */
        #canvasWrapper {
            flex: 1; /* Bo≈ü alanƒ± doldur */
            min-height: 0; /* Gerekirse k√º√ß√ºlmesine izin ver! (√áok √∂nemli) */
            width: 100%; 
            background: #81ecec;
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            position: relative; 
            overflow: hidden; 
            border: 4px solid #fff;
            touch-action: none;
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 10px; touch-action: none; }
        
        /* --- KONTROL PANELƒ∞ (Sabit - Alt) --- */
        #sidePanel {
            height: auto; /* ƒ∞√ßeriƒüi kadar yer kapla */
            flex-shrink: 0; /* Asla b√ºz√º≈üme, haritayƒ± b√ºz */
            width: 100%;
            display: flex; 
            flex-direction: column; 
            gap: 8px;
            /* iPhone alt √ßizgi g√ºvenli alan */
            padding-bottom: env(safe-area-inset-bottom);
            margin-bottom: 5px;
        }

        /* --- KARTLAR --- */
        .cards-container { display: flex; gap: 8px; width: 100%; }

        .info-card {
            flex: 1; background: var(--panel-bg); padding: 8px 10px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s;
            border-left: 5px solid #ddd; position: relative;
            display: flex; flex-direction: column; justify-content: center;
        }
        .player-card.active { transform: scale(1.02); border-color: gold !important; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        
        .card-content { display: flex; align-items: center; gap: 8px; }
        .flag { font-size: 20px; }
        .stats h3 { margin: 0; font-size: 12px; color: #2d3436; white-space: nowrap; }
        .stats p { margin: 0; font-size: 11px; color: #636e72; font-weight: bold; }

        .limit-bar-bg { width: 100%; height: 4px; background: #eee; border-radius: 2px; margin-top: 4px; overflow: hidden; border:1px solid #ccc;}
        .limit-bar-fill { height: 100%; width: 0%; background: #00b894; transition: width 0.1s; }

        #turnBadge {
            background: #6c5ce7; color: white; text-align: center; padding: 6px;
            border-radius: 8px; font-size: 12px; box-shadow: 0 2px 0 rgba(0,0,0,0.1);
            font-weight: bold; margin-bottom: 2px;
        }

        /* --- SONU√á KUTUSU --- */
        #lastResultBox {
            background: white; padding: 6px; border-radius: 10px;
            text-align: center; font-size: 11px; color: #555;
            min-height: 30px; display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05); border: 2px dashed #ccc;
            transition: all 0.3s;
        }
        #lastResultBox.win { background: #dff9fb; border-color: #00b894; color: #009432; }
        #lastResultBox.lose { background: #ffcccc; border-color: #d63031; color: #d63031; }

        /* --- ZAR VE BUTON --- */
        #actionArea {
            position: relative; height: 50px; width: 100%;
            display: flex; align-items: center; gap: 10px;
        }
        
        .dice-container {
            width: 45px; height: 45px; perspective: 800px;
            flex-shrink: 0;
        }
        .dice-box { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; }
        .dice-face {
            position: absolute; width: 100%; height: 100%; background: white;
            border: 1px solid #b2bec3; border-radius: 8px; display: flex;
            justify-content: center; align-items: center; font-size: 20px; font-weight: bold;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1); color: #2d3436;
        }
        .df1 { transform: translateZ(22px); } .df2 { transform: rotateY(180deg) translateZ(22px); }
        .df3 { transform: rotateY(90deg) translateZ(22px); } .df4 { transform: rotateY(-90deg) translateZ(22px); }
        .df5 { transform: rotateX(90deg) translateZ(22px); } .df6 { transform: rotateX(-90deg) translateZ(22px); }

        #rollBtn {
            flex-grow: 1; height: 45px;
            border: none; border-radius: 12px; background: #dfe6e9; color: #636e72;
            font-size: 15px; font-weight: bold; cursor: not-allowed; transition: all 0.3s;
            box-shadow: 0 4px 0 #b2bec3;
        }
        #rollBtn.ready { background: #0984e3; color: white; cursor: pointer; box-shadow: 0 4px 0 #074f83; animation: pulseBtn 1s infinite; }
        #rollBtn:active { transform: translateY(4px); box-shadow: 0 0 0 #074f83; }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center; z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-card { background: white; padding: 25px; border-radius: 25px; text-align: center; max-width: 500px; width: 85%; transform: scale(0.8); transition: transform 0.3s; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-overlay.active .modal-card { transform: scale(1); }

        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .player-select { background: #f8f9fa; padding: 10px; border-radius: 12px; }
        .primary-btn { background: linear-gradient(45deg, #0984e3, #74b9ff); color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 15px rgba(9, 132, 227, 0.4); width: 100%; margin-top: 10px;}

        .rules-box { text-align:left; font-size:12px; color:#555; background:#f1f2f6; padding:10px; border-radius:10px; margin-bottom:15px; line-height: 1.4; border: 1px solid #ddd; }
        .rule-row { display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; padding: 2px 0; }
        .rule-win { color: #009432; font-weight: bold; }
        .rule-lose { color: #d63031; font-weight: bold; }

        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* Masa√ºst√º */
        @media (min-width: 769px) {
            #gameLayout { flex-direction: row; }
            #sidePanel { width: 320px; height: 100%; justify-content: space-between; }
            .cards-container { flex-direction: column; }
            #actionArea { height: 120px; flex-direction: column; justify-content: center; }
            .dice-container { width: 60px; height: 60px; margin-bottom: 15px; }
            #rollBtn { width: 100%; }
        }
    </style>
</head>
<body>

    <div id="setupModal" class="modal-overlay active">
        <div class="modal-card">
            <h2 style="color:#2c3e50; margin:0 0 5px 0;">üåç Boyama Sava≈ülarƒ±</h2>
            <p style="color:#7f8c8d; font-size:14px; margin:0;">Mobil S√ºr√ºm</p>
            
            <div class="setup-grid">
                <div class="player-select" style="border: 2px solid var(--p1-color);">
                    <div style="font-size:30px;" id="p1FlagPreview">‚ùì</div>
                    <select id="p1Select" onchange="updatePreview('p1')" style="width:100%"></select>
                </div>
                <div class="player-select" style="border: 2px solid var(--p2-color);">
                    <div style="font-size:30px;" id="p2FlagPreview">‚ùì</div>
                    <select id="p2Select" onchange="updatePreview('p2')" style="width:100%"></select>
                </div>
            </div>
            
            <div class="rules-box">
                <div class="rule-row"><span>1Ô∏è‚É£</span> <span class="rule-win">Tam Kazan</span></div>
                <div class="rule-row"><span>2Ô∏è‚É£</span> <span class="rule-lose">Tam Silinir</span></div>
                <div class="rule-row"><span>3Ô∏è‚É£</span> <span class="rule-win">2 KAT KAZAN</span></div>
                <div class="rule-row"><span>4Ô∏è‚É£</span> <span class="rule-lose">2 KAT KAYBET</span></div>
                <div class="rule-row"><span>5Ô∏è‚É£</span> <span class="rule-win">¬Ω Yarƒ±m Kazan</span></div>
                <div class="rule-row"><span>6Ô∏è‚É£</span> <span class="rule-lose">¬Ω Yarƒ±m Kaybet</span></div>
            </div>

            <button class="primary-btn" onclick="finishSetup()">BA≈ûLAT üöÄ</button>
        </div>
    </div>

    <div id="tugOfWarBar">
        <div id="barP1">P1 %50</div>
        <div id="barCenter"></div>
        <div id="barP2">P2 %50</div>
    </div>

    <div id="gameLayout">
        <div id="canvasWrapper">
            <canvas id="bgCanvas"></canvas>
            <canvas id="mapCanvas"></canvas>
            <canvas id="uiCanvas"></canvas>
            <canvas id="fxCanvas" style="pointer-events: none;"></canvas>
        </div>

        <div id="sidePanel">
            <div id="turnBadge">Sƒ±ra: Bekleniyor</div>

            <div class="cards-container">
                <div id="p1Card" class="info-card player-card active" style="border-color: var(--p1-color);">
                    <div class="card-content">
                        <div class="flag" id="p1FlagDisp">üè≥Ô∏è</div>
                        <div class="stats" style="flex-grow:1">
                            <h3 id="p1NameDisp">P1</h3>
                            <p id="p1Score">---</p>
                        </div>
                    </div>
                    <div class="limit-bar-bg"><div id="p1LimitBar" class="limit-bar-fill"></div></div>
                </div>

                <div id="p2Card" class="info-card player-card" style="border-color: var(--p2-color);">
                    <div class="card-content">
                        <div class="flag" id="p2FlagDisp">üè≥Ô∏è</div>
                        <div class="stats" style="flex-grow:1">
                            <h3 id="p2NameDisp">P2</h3>
                            <p id="p2Score">---</p>
                        </div>
                    </div>
                    <div class="limit-bar-bg"><div id="p2LimitBar" class="limit-bar-fill"></div></div>
                </div>
            </div>

            <div id="lastResultBox">Sava≈ü ba≈ülƒ±yor...</div>

            <div id="actionArea">
                <div class="dice-container">
                    <div class="dice-box" id="gameDice">
                        <div class="dice-face df1">1</div>
                        <div class="dice-face df2">2</div>
                        <div class="dice-face df3">3</div>
                        <div class="dice-face df4">4</div>
                        <div class="dice-face df5">5</div>
                        <div class="dice-face df6">6</div>
                    </div>
                </div>
                <button id="rollBtn">ALAN √áƒ∞Z üëá</button>
            </div>
        </div>
    </div>

<script>
// --- AYARLAR ---
const COUNTRIES = [
    { code: 'TR', name: 'T√ºrkiye', flag: 'üáπüá∑' }, { code: 'AZ', name: 'Azerbaycan', flag: 'üá¶üáø' },
    { code: 'US', name: 'ABD', flag: 'üá∫üá∏' }, { code: 'DE', name: 'Almanya', flag: 'üá©üá™' },
    { code: 'JP', name: 'Japonya', flag: 'üáØüáµ' }, { code: 'KR', name: 'G√ºney Kore', flag: 'üá∞üá∑' },
    { code: 'BR', name: 'Brezilya', flag: 'üáßüá∑' }, { code: 'RU', name: 'Rusya', flag: 'üá∑üá∫' },
    { code: 'CN', name: '√áin', flag: 'üá®üá≥' }, { code: 'FR', name: 'Fransa', flag: 'üá´üá∑' },
    { code: 'IN', name: 'Hindistan', flag: 'üáÆüá≥' }, { code: 'GB', name: 'ƒ∞ngiltere', flag: 'üá¨üáß' }
];

const p1Sel = document.getElementById('p1Select');
const p2Sel = document.getElementById('p2Select');
COUNTRIES.forEach((c, i) => { p1Sel.add(new Option(c.name, i)); p2Sel.add(new Option(c.name, i)); });
p1Sel.selectedIndex = 0; p2Sel.selectedIndex = 1;
updatePreview('p1'); updatePreview('p2');

function updatePreview(p) {
    const idx = document.getElementById(p+'Select').value;
    document.getElementById(p+'FlagPreview').innerText = COUNTRIES[idx].flag;
}

let player1 = {}, player2 = {};
let gameState = {
    started: false,
    readyToPlay: false,
    turn: 'p1',
    isDrawing: false,
    pathPoints: [],
    canRoll: false,
    isRolling: false,
    scores: { p1: 100000, p2: 100000 },
    limitRatio: 1.0
};

// --- SES ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playTone(freq, type, duration, delay=0, vol=0.1) {
    if(audioCtx.state==='suspended') audioCtx.resume();
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type=type; o.frequency.setValueAtTime(freq, audioCtx.currentTime+delay);
    g.gain.setValueAtTime(0, audioCtx.currentTime+delay);
    g.gain.linearRampToValueAtTime(vol, audioCtx.currentTime+delay+0.05);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+delay+duration);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(audioCtx.currentTime+delay); o.stop(audioCtx.currentTime+delay+duration);
}
function playSound(ev) {
    if(ev==='draw') playTone(400+Math.random()*200, 'sine', 0.05, 0, 0.05);
    if(ev==='tick') playTone(800, 'square', 0.02, 0, 0.05);
    if(ev==='ready') playTone(1000, 'sine', 0.2);
    if(ev==='win') { playTone(523, 'sine', 0.3); playTone(659, 'sine', 0.3, 0.1); }
    if(ev==='lose') { playTone(300, 'sawtooth', 0.3); playTone(200, 'sawtooth', 0.3, 0.1); }
    if(ev==='limit') { playTone(200, 'sawtooth', 0.1); }
}

// --- CANVAS ---
const bgCanvas = document.getElementById('bgCanvas');
const mapCanvas = document.getElementById('mapCanvas');
const uiCanvas = document.getElementById('uiCanvas');
const fxCanvas = document.getElementById('fxCanvas');
const ctxBg = bgCanvas.getContext('2d');
const ctxMap = mapCanvas.getContext('2d', { willReadFrequently: true });
const ctxUi = uiCanvas.getContext('2d');
const ctxFx = fxCanvas.getContext('2d');

function finishSetup() {
    const idx1 = p1Sel.value; const idx2 = p2Sel.value;
    player1 = { ...COUNTRIES[idx1], color: '#ff7675' };
    player2 = { ...COUNTRIES[idx2], color: '#74b9ff' };
    
    document.getElementById('p1NameDisp').innerText = player1.name;
    document.getElementById('p1FlagDisp').innerText = player1.flag;
    document.getElementById('p2NameDisp').innerText = player2.name;
    document.getElementById('p2FlagDisp').innerText = player2.flag;
    document.getElementById('setupModal').classList.remove('active');
    
    gameState.started = true;
    resize();
    
    setTimeout(() => { 
        drawInitialAreas(); 
        setTimeout(() => { updateScores(); gameState.readyToPlay = true; }, 300);
    }, 100);

    updateTurnIndicator();
}

function resize() {
    const w = document.getElementById('canvasWrapper');
    [bgCanvas, mapCanvas, uiCanvas, fxCanvas].forEach(c => { c.width = w.clientWidth; c.height = w.clientHeight; });
    if(gameState.started) { drawCuteMap(); drawInitialAreas(); }
}
window.addEventListener('resize', resize);

// --- SEVƒ∞MLƒ∞ HARƒ∞TA (AƒûA√áLAR GERƒ∞ GELDƒ∞) ---
function drawCuteMap() {
    ctxBg.clearRect(0,0,bgCanvas.width, bgCanvas.height);
    
    // Su Rengi
    // Grid (Hafif)
    ctxBg.strokeStyle = 'rgba(255,255,255,0.15)'; ctxBg.lineWidth=1;
    for(let i=0; i<bgCanvas.width; i+=50) { ctxBg.beginPath(); ctxBg.moveTo(i,0); ctxBg.lineTo(i,bgCanvas.height); ctxBg.stroke(); }
    for(let i=0; i<bgCanvas.height; i+=50) { ctxBg.beginPath(); ctxBg.moveTo(0,i); ctxBg.lineTo(bgCanvas.width,i); ctxBg.stroke(); }

    // Kƒ±talar (Ye≈üil Adalar)
    ctxBg.fillStyle = '#b8e994'; // A√ßƒ±k ye≈üil
    const lands = [
        {x:0.2, y:0.3, r:70}, {x:0.7, y:0.3, r:80}, // √ústler
        {x:0.5, y:0.65, r:60}, {x:0.8, y:0.7, r:50} // Altlar
    ];
    lands.forEach(l => {
        let cx = l.x*bgCanvas.width; let cy = l.y*bgCanvas.height;
        // Oyuncu alanlarƒ±na yakƒ±nsa √ßizme
        if(Math.hypot(cx, cy-bgCanvas.height)<200 || Math.hypot(cx-bgCanvas.width, cy)<200) return;
        
        ctxBg.beginPath();
        // Amip ≈üekli (Sevimli)
        for(let a=0; a<Math.PI*2; a+=0.5) {
            let r = l.r + Math.random()*20;
            ctxBg.lineTo(cx+Math.cos(a)*r, cy+Math.sin(a)*r);
        }
        ctxBg.fill();
    });

    // S√ºslemeler (Emoji)
    ctxBg.font = "24px Arial"; ctxBg.textAlign="center";
    const items = ["üå≤", "üå≥", "‚õ∞Ô∏è", "üè†", "‚õ∫"];
    for(let i=0; i<15; i++) {
        let x = Math.random()*bgCanvas.width;
        let y = Math.random()*bgCanvas.height;
        // Sadece karaya (ye≈üile) veya bo≈üluƒüa koy, ama oyuncu √ºst√ºne koyma
        if(Math.hypot(x, y-bgCanvas.height)<220 || Math.hypot(x-bgCanvas.width, y)<220) continue;
        ctxBg.fillText(items[Math.floor(Math.random()*items.length)], x, y);
    }
}

function drawInitialAreas() {
    ctxMap.fillStyle = player1.color; ctxMap.beginPath(); ctxMap.arc(0, mapCanvas.height, 150, 0, Math.PI*2); ctxMap.fill();
    ctxMap.fillStyle = player2.color; ctxMap.beginPath(); ctxMap.arc(mapCanvas.width, 0, 150, 0, Math.PI*2); ctxMap.fill();
}

// --- Gƒ∞Rƒ∞≈û Cƒ∞HAZLARI ---
function getPos(e) {
    const r = uiCanvas.getBoundingClientRect();
    let x, y;
    if (e.touches && e.touches.length > 0) {
        x = e.touches[0].clientX; y = e.touches[0].clientY;
    } else {
        x = e.clientX; y = e.clientY;
    }
    return { x: x - r.left, y: y - r.top };
}

uiCanvas.addEventListener('mousedown', startD);
uiCanvas.addEventListener('touchstart', startD, {passive: false});
uiCanvas.addEventListener('mousemove', moveD);
uiCanvas.addEventListener('touchmove', moveD, {passive: false});
uiCanvas.addEventListener('mouseup', endD);
uiCanvas.addEventListener('touchend', endD);

function startD(e) {
    if(!gameState.started || gameState.canRoll || gameState.isRolling) return;
    if(e.cancelable) e.preventDefault(); 
    const p = getPos(e);
    
    const px = ctxMap.getImageData(p.x, p.y, 1, 1).data;
    const isP1 = (gameState.turn === 'p1' && px[0] > px[2]);
    const isP2 = (gameState.turn === 'p2' && px[2] > px[0]);
    if(!isP1 && !isP2) return;

    gameState.isDrawing = true; gameState.pathPoints = [p];
    playSound('draw');
    ctxUi.beginPath(); ctxUi.moveTo(p.x, p.y);
    ctxUi.strokeStyle = '#2d3436'; ctxUi.lineWidth = 3; ctxUi.setLineDash([5,5]);
}

function moveD(e) {
    if(!gameState.isDrawing) return;
    if(e.cancelable) e.preventDefault();
    const p = getPos(e);
    gameState.pathPoints.push(p);
    
    const currentArea = calculatePolyArea(gameState.pathPoints);
    const maxAllowed = gameState.scores[gameState.turn] * gameState.limitRatio;
    const ratio = Math.min(100, (currentArea / maxAllowed) * 100);
    
    const bar = document.getElementById(gameState.turn==='p1'?'p1LimitBar':'p2LimitBar');
    bar.style.width = ratio + '%';
    
    if (currentArea > maxAllowed) {
        bar.style.background = 'red'; ctxUi.strokeStyle = 'red';
        if(Math.random()>0.9) playSound('limit');
    } else {
        bar.style.background = '#00b894'; ctxUi.strokeStyle = '#2d3436';
    }

    ctxUi.clearRect(0,0,uiCanvas.width, uiCanvas.height);
    ctxUi.beginPath(); ctxUi.moveTo(gameState.pathPoints[0].x, gameState.pathPoints[0].y);
    for(let pt of gameState.pathPoints) ctxUi.lineTo(pt.x, pt.y);
    ctxUi.stroke();
}

function endD() {
    if(!gameState.isDrawing) return;
    gameState.isDrawing = false;
    ctxUi.closePath();
    ctxUi.fillStyle = 'rgba(0,0,0,0.1)'; ctxUi.fill();
    
    const area = calculatePolyArea(gameState.pathPoints);
    const maxAllowed = gameState.scores[gameState.turn] * gameState.limitRatio;

    document.getElementById('p1LimitBar').style.width = '0%'; document.getElementById('p2LimitBar').style.width = '0%';

    if(area < 100) { ctxUi.clearRect(0,0,uiCanvas.width, uiCanvas.height); return; }
    if(area > maxAllowed) { 
        alert("Sƒ±nƒ±rƒ± a≈ütƒ±n!"); 
        ctxUi.clearRect(0,0,uiCanvas.width, uiCanvas.height); 
        return; 
    }
    
    gameState.canRoll = true;
    const btn = document.getElementById('rollBtn');
    btn.classList.add('ready');
    btn.innerHTML = `üé≤ ZAR AT`;
    playSound('ready');
}

document.getElementById('rollBtn').addEventListener('click', () => {
    if(!gameState.canRoll) return;
    gameState.isRolling = true;
    document.getElementById('rollBtn').classList.remove('ready');
    const target = Math.floor(Math.random()*6)+1;
    animateDice(target);
});

function animateDice(target) {
    const box = document.getElementById('gameDice');
    let frame = 0;
    const loop = setInterval(() => {
        frame++;
        const rx = Math.random()*360 + frame*10;
        const ry = Math.random()*360 + frame*10;
        box.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg) scale(1.1)`;
        if(frame%5===0) playSound('tick');
        if(frame >= 60) {
            clearInterval(loop);
            let tx=0, ty=0;
            if(target==1) {tx=0; ty=0;} if(target==2) {tx=0; ty=180;}
            if(target==3) {tx=0; ty=-90;} if(target==4) {tx=0; ty=90;}
            if(target==5) {tx=-90; ty=0;} if(target==6) {tx=90; ty=0;}
            box.style.transform = `rotateX(${tx}deg) rotateY(${ty}deg) scale(1)`;
            processResult(target);
        }
    }, 16);
}

function processResult(res) {
    const player = gameState.turn === 'p1' ? player1 : player2;
    const center = getCentroid(gameState.pathPoints);
    const box = document.getElementById('lastResultBox');
    
    let scale = 1, mode = 'source-over', msg = "", sound = "win", color = player.color;

    switch(res) {
        case 1: scale=1; mode='source-over'; msg="TAM ƒ∞SABET! Alanƒ± kaptƒ±n."; sound='win'; break;
        case 2: scale=1; mode='destination-out'; msg="KAYIP! Se√ßtiƒüin yer silindi."; sound='lose'; break;
        case 3: scale=1.41; mode='source-over'; msg="2 KAT KAZAN√á! B√ºy√ºyerek aldƒ±n!"; sound='win'; break;
        case 4: scale=1.41; mode='destination-out'; msg="2 KAT KAYIP! B√ºy√ºk hasar!"; sound='lose'; break;
        case 5: scale=0.7; mode='source-over'; msg="KISMƒ∞. Yarƒ±sƒ±nƒ± kazandƒ±n."; sound='win'; break;
        case 6: scale=0.7; mode='destination-out'; msg="≈ûANSLI. Sadece yarƒ±sƒ± gitti."; sound='lose'; break;
    }

    playSound(sound);
    spawnParticles(center.x, center.y, mode==='source-over'?color:'#555', scale*20);
    
    ctxMap.save();
    ctxMap.translate(center.x, center.y); ctxMap.scale(scale, scale); ctxMap.translate(-center.x, -center.y);
    ctxMap.globalCompositeOperation = mode;
    ctxMap.fillStyle = color;
    ctxMap.beginPath();
    ctxMap.moveTo(gameState.pathPoints[0].x, gameState.pathPoints[0].y);
    for(let p of gameState.pathPoints) ctxMap.lineTo(p.x, p.y);
    ctxMap.closePath(); ctxMap.fill();
    ctxMap.restore();
    ctxMap.globalCompositeOperation = 'source-over';

    box.innerHTML = `<b>${res}</b>: ${msg}`;
    box.className = mode==='source-over'?'win':'lose';

    setTimeout(() => {
        ctxUi.clearRect(0,0,uiCanvas.width, uiCanvas.height);
        gameState.pathPoints = []; gameState.canRoll = false; gameState.isRolling = false;
        document.getElementById('rollBtn').innerHTML = "ALAN √áƒ∞Z üëá";
        updateScores(); switchTurn();
    }, 1500);
}

function getCentroid(pts) {
    let x=0, y=0; for(let p of pts){x+=p.x; y+=p.y;}
    return {x:x/pts.length, y:y/pts.length};
}

function calculatePolyArea(pts) {
    let a=0;
    for(let i=0; i<pts.length; i++) {
        let j=(i+1)%pts.length; a += pts[i].x*pts[j].y; a -= pts[j].x*pts[i].y;
    }
    return Math.abs(a/2);
}

function updateScores() {
    if (!gameState.readyToPlay) return;
    const d = ctxMap.getImageData(0,0,mapCanvas.width, mapCanvas.height).data;
    let s1=0, s2=0;
    for(let i=0; i<d.length; i+=16) {
        if(d[i+3]>50) { if(d[i]>d[i+2]) s1++; else s2++; }
    }
    const realS1 = s1 * 4; const realS2 = s2 * 4;
    gameState.scores.p1 = realS1; gameState.scores.p2 = realS2;
    document.getElementById('p1Score').innerText = Math.floor(realS1/100) + " br";
    document.getElementById('p2Score').innerText = Math.floor(realS2/100) + " br";
    const total = realS1 + realS2 + 1;
    document.getElementById('barP1').style.width = (realS1/total)*100+"%";
    document.getElementById('barP1').innerText = player1.name;
    document.getElementById('barP2').style.width = (realS2/total)*100+"%";
    document.getElementById('barP2').innerText = player2.name;

    if(gameState.readyToPlay) {
        if(realS1 < 1000) { alert("üèÜ " + player2.name + " KAZANDI!"); location.reload(); }
        if(realS2 < 1000) { alert("üèÜ " + player1.name + " KAZANDI!"); location.reload(); }
    }
}

function switchTurn() {
    gameState.turn = gameState.turn === 'p1' ? 'p2' : 'p1';
    updateTurnIndicator();
}

function updateTurnIndicator() {
    const badge = document.getElementById('turnBadge');
    document.getElementById('p1Card').classList.remove('active');
    document.getElementById('p2Card').classList.remove('active');
    if(gameState.turn === 'p1') {
        badge.innerHTML = `Sƒ±ra: ${player1.flag} ${player1.name}`;
        badge.style.background = player1.color;
        document.getElementById('p1Card').classList.add('active');
    } else {
        badge.innerHTML = `Sƒ±ra: ${player2.flag} ${player2.name}`;
        badge.style.background = player2.color;
        document.getElementById('p2Card').classList.add('active');
    }
}

let particles = [];
function spawnParticles(x,y,c, count=20) {
    for(let i=0;i<count;i++) particles.push({x:x,y:y,vx:(Math.random()-.5)*15,vy:(Math.random()-.5)*15,life:1,c:c});
}
function loopFx() {
    ctxFx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
    particles.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.life-=0.04;
        ctxFx.globalAlpha=p.life; ctxFx.fillStyle=p.c; 
        ctxFx.beginPath(); ctxFx.arc(p.x,p.y,4,0,Math.PI*2); ctxFx.fill();
    });
    particles=particles.filter(p=>p.life>0);
    requestAnimationFrame(loopFx);
}
loopFx();
</script>
</body>
</html>